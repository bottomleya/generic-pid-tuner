<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">

        <link href="https://fonts.googleapis.com/css?family=Raleway:300,400,500" rel="stylesheet">
        <link rel="stylesheet" href="css/style.css">
        <link rel="stylesheet" href="css/Chart.min.css">
        

        <script src="js/jquery-3.4.1.min.js"></script>
        <script src="js/math.js"></script>
        <script src="js/Chart.min.js"></script>

        <title>Generic PID Controller Tuner</title>
        
    </head>
    <body>
    <div class="heading">
        <b>Generic PID Controller Tuner</b>
        </br>
        <label for="maxDataPoints">Number of data points displayed:</label>
        <input type="number" id="maxDataPoints" name="maxDataPoints" min="1" max="100" defaultValue="1000">
        </br>
        <label for="setPoint">Setpoint for System Dynamics:</label>
        <input type="number" id="setPoint" name="setPoint" min="1" max="100" defaultValue="25">
        </br>
        <label for="controller">Controller:</label>
        <input type="number" id="controller" name="controller" min="0" max="100" defaultValue="0">

        
    </div>
    
    <canvas id="chart_canvas"></canvas>
        
        <script>
            
            var canvas = document.getElementById('chart_canvas');
            var ctx = canvas.getContext('2d');
            
            var userSettings = {"maxDataPoints": 1000,
                                "setPoint": 25,
                                "controller": 0};
            
            for (key in userSettings) {
                document.getElementById(key).value = document.getElementById(key).defaultValue;
            }
            
            Chart.defaults.global.defaultFontColor = "#fff";
            
            
            // Generate random data to plot
            var data = {
                labels: [""],
                datasets: [
                    {
                        label: "System Dynamics",
                        fill: false,
                        lineTension: 0.5,
                        borderColor: "rgba(226, 235, 52, 1)",
                        borderCapStyle: 'butt',
                        borderDash: [],
                        borderDashOffset: 0.0,
                        pointBorderWidth: 0,
                        pointRadius: 0,
                        data: [0],
                    },
                    {
                        label: "Setpoint",
                        fill: false,
                        lineTension: 0.1,
                        borderColor: "rgba(52, 235, 232, 1)",
                        borderCapStyle: 'butt',
                        borderDash: [],
                        borderDashOffset: 0.0,
                        pointRadius: 0,
                        pointBorderWidth: 0,
                        data: [25],
                    },
                    {
                        label: "Controller",
                        fill: false,
                        lineTension: 0.1,
                        borderColor: "rgba(168, 50, 50, 1)",
                        borderCapStyle: 'butt',
                        borderDash: [],
                        borderDashOffset: 0.0,
                        pointRadius: 0,
                        pointBorderWidth: 0,
                        data: [0],
                    }
                ]
            };
            function updateInputValues() {
                for (var key in userSettings) {
                    userSettings[key] = document.getElementById(key).value;
                }
            }
            function systemDynamics() {
                // get most recent data points
                currVal = data.datasets[0].data.slice(-1)[0]
                controller = data.datasets[2].data.slice(-1)[0]
                // apply system dynamics
                // newVal = Math.random()*10;
                // newVal = currVal + 0.1 * (setPoint - currVal);
                newVal = currVal + 0.05 * controller
                return newVal
            }
            function addDataPoint() {
                updateInputValues();
                maxDataPoints = userSettings["maxDataPoints"];
                setPoint = userSettings["setPoint"];
                // calculate system dynamics
                newVal = systemDynamics();
                // add data
                data.datasets[0].data.push(newVal);
                data.datasets[1].data.push(setPoint);
                data.labels.push("");
                // limit to maximum number of data points
                if (data.datasets[0].data.length > maxDataPoints) {
                    for (var i=0; i<data.datasets.length; i++) {
                        data.datasets[i].data.shift();
                        data.labels.shift();
                    }
                }
                // update chart
                lineChart.data = data;
                lineChart.update();
            }
            var lineChart = new Chart(ctx, {
                type: 'line',
                data: data,
                options: { 
                    animation: false,
                    showLines: true,
                    events: [],
                    scales: {
                        yAxes: [{
                            display: true,
                            ticks: {
                                suggestedMin: 0,
                                suggestedMax: 100
                            }
                        }]
                    }
                }
            });

            window.setInterval(function(){
                addDataPoint();
            }, 100);

         
        </script>
    </body>
</html>
